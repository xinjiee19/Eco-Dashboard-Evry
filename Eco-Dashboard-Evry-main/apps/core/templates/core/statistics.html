{% extends 'base.html' %}
{% load static %}

{% block title %}Statistiques & Comparaisons - Bilan Carbone{% endblock %}

{% block content %}
<div class="container">


    <div class="page-header">
        <h2 class="page-title">üìä √âvolution & Statistiques Comparatives</h2>
        <a href="{% url 'dashboard' %}" class="btn btn--secondary">‚Üê Retour au Tableau de bord</a>
    </div>

    <!-- Global Evolution Chart -->
    <div class="chart-section">
        <h3 class="section-title">üìÖ √âvolution Globale des √âmissions (Ann√©e par Ann√©e)</h3>
        <div class="chart-container-large"
            style="height: 400px; width: 100%; position: relative; border: 1px solid #eee;">
            <canvas id="globalEvolutionChart"></canvas>
        </div>
    </div>

    <!-- Sector Evolution Chart -->
    <div class="chart-section">
        <h3 class="section-title">üß± R√©partition par Secteur (Comparatif)</h3>
        <!-- Global Legend Container -->
        <div id="globalLegendContainer"></div>
        <!-- Container for multiple Doughnut Charts -->
        <div id="sectorChartsContainer" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
            <p style="color:#666; width:100%; text-align:center;">Chargement des graphiques...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        try {
            // Fetch data from API
            const response = await fetch('{% url "statistics_data_api" %}');
            if (!response.ok) {
                throw new Error('R√©ponse r√©seau non OK: ' + response.statusText);
            }

            const apiData = await response.json();
            const years = apiData.years;
            // stacked_data contains totals per sector for the top chart
            const stackedData = apiData.stacked_data;
            // details_data contains breakdown per year per sector
            const detailsData = apiData.details_data; // { 2025: { 'buildings': {'Gaz': 100...}, ... } }

            console.log("Donn√©es re√ßues:", apiData);

            if (!years || years.length === 0) {
                console.warn("Aucune ann√©e trouv√©e");
            }

            // --- Color Mapping & Global Legend Logic ---
            const colorMap = {
                // B√¢timents
                '√âlectricit√©': '#f1c40f',
                'Gaz Naturel': '#3498db',
                'R√©seau Chaleur': '#e67e22',
                'Climatisation': '#2ecc71',
                // V√©hicules
                'Essence': '#e74c3c',
                'Gazole': '#2980b9',
                'Distance (Mixte)': '#95a5a6',
                // Alimentation
                'B≈ìuf': '#c0392b',
                'Porc': '#e67e22',
                'Volaille/Poisson': '#f1c40f',
                'V√©g√©tarien': '#2ecc71',
                'Pique-nique': '#9b59b6',
                // Achats
                'Restauration & Services l√©gers': '#f39c12',
                'Assurances & Cotisations': '#3498db',
                'IT & T√©l√©phonie': '#8e44ad',
                'Nettoyage & Entretien & Espaces verts': '#27ae60',
                'S√©jours & Activit√©s': '#16a085',
                'Blanchisserie': '#bdc3c7',
                'Travaux & Construction': '#d35400',
                'Transports': '#2c3e50',
                'Location √©quipements': '#7f8c8d',
                // Num√©rique
                'Ordinateur Portable': '#1abc9c',
                'Ordinateur Fixe + √âcran': '#16a085',
                'Smartphone / Tablette': '#e67e22',
                'Borne Wi-Fi': '#34495e',
                'Switch r√©seau': '#2c3e50',
                'Instance Cloud / Serveur virtuel': '#9b59b6',
                'Stockage Cloud 1 To': '#8e44ad',
                'Imprimante Laser': '#95a5a6',
                '√âcran suppl√©mentaire': '#bdc3c7',
            };

            const getFixedColor = (label) => {
                // Normalize label if needed (e.g. remove parenthesis logic was done in API but map keys must match)
                // API keys are like "Ordinateur Portable".
                if (colorMap[label]) return colorMap[label];
                let hash = 0;
                for (let i = 0; i < label.length; i++) {
                    hash = label.charCodeAt(i) + ((hash << 5) - hash);
                }
                const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
                return '#' + "00000".substring(0, 6 - c.length) + c;
            };

            const renderGlobalLegends = () => {
                const groups = {
                    "B√¢timents": ['√âlectricit√©', 'Gaz Naturel', 'R√©seau Chaleur', 'Climatisation'],
                    "V√©hicules": ['Essence', 'Gazole', 'Distance (Mixte)'],
                    "Alimentation": ['B≈ìuf', 'Porc', 'Volaille/Poisson', 'V√©g√©tarien', 'Pique-nique'],
                    "Achats": ['Restauration & Services l√©gers', 'Assurances & Cotisations', 'IT & T√©l√©phonie',
                        'Nettoyage & Entretien & Espaces verts', 'S√©jours & Activit√©s',
                        'Blanchisserie', 'Travaux & Construction', 'Transports', 'Location √©quipements'],
                    "Num√©rique": ['Ordinateur Portable', 'Ordinateur Fixe + √âcran', 'Smartphone / Tablette',
                        'Instance Cloud / Serveur virtuel', 'Imprimante Laser']
                };

                const container = document.getElementById('globalLegendContainer');
                if (!container) return;

                container.innerHTML = '';
                container.style.display = 'flex';
                container.style.flexWrap = 'wrap';
                container.style.gap = '2rem';
                container.style.justifyContent = 'center';
                container.style.marginBottom = '2rem';
                container.style.padding = '1.5rem';
                container.style.backgroundColor = '#f8f9fa';
                container.style.borderRadius = '8px';
                container.style.border = '1px solid #e9ecef';

                for (const [groupName, labels] of Object.entries(groups)) {
                    const groupDiv = document.createElement('div');
                    groupDiv.innerHTML = `<strong style="display:block; margin-bottom:0.5rem; color:#2d6a4f;">${groupName}</strong>`;

                    labels.forEach(label => {
                        const color = getFixedColor(label);
                        const item = document.createElement('div');
                        item.style.display = 'flex';
                        item.style.alignItems = 'center';
                        item.style.fontSize = '0.8rem';
                        item.style.marginBottom = '4px';
                        item.innerHTML = `
                            <span style="display:inline-block; width:12px; height:12px; background-color:${color}; margin-right:6px; border-radius:2px;"></span>
                            <span style="color:#555;">${label}</span>
                        `;
                        groupDiv.appendChild(item);
                    });
                    container.appendChild(groupDiv);
                }
            };

            renderGlobalLegends();

            // --- 1. Global Evolution Chart (Stacked Bar) ---
            // Le client veut voir les secteurs appara√Ætre (photo 1)
            const ctxGlobal = document.getElementById('globalEvolutionChart').getContext('2d');
            new Chart(ctxGlobal, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'V√©hicules',
                            data: stackedData.vehicles,
                            backgroundColor: '#4A90E2'
                        },
                        {
                            label: 'B√¢timents',
                            data: stackedData.buildings,
                            backgroundColor: '#F39C12'
                        },
                        {
                            label: 'Alimentation',
                            data: stackedData.food,
                            backgroundColor: '#27AE60'
                        },
                        {
                            label: 'Achats',
                            data: stackedData.purchases,
                            backgroundColor: '#9B59B6'
                        },
                        {
                            label: 'Num√©rique',
                            data: stackedData.numerique,
                            backgroundColor: '#34495E'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.raw.toLocaleString('fr-FR') + ' kgCO‚ÇÇe';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true }, // Empil√©
                        y: {
                            stacked: true, // Empil√©
                            beginAtZero: true,
                            title: { display: true, text: 'kgCO‚ÇÇe' }
                        }
                    }
                }
            });

            // --- 2. Sector Distribution (Detailed Doughnuts per Year) ---
            const sectorContainer = document.getElementById('sectorChartsContainer');
            sectorContainer.innerHTML = '';

            // Helper to create a specific doughnut
            const createDetailedDoughnut = (container, title, breakdownData) => {
                // If data is empty or all zeros, skip
                if (!breakdownData || Object.values(breakdownData).every(v => v === 0)) return;

                const wrapper = document.createElement('div');
                wrapper.className = 'doughnut-wrapper';
                wrapper.style.flex = '1 1 200px';
                wrapper.style.marginBottom = '20px';
                wrapper.style.textAlign = 'center';
                wrapper.style.display = 'flex';
                wrapper.style.flexDirection = 'column';
                wrapper.style.alignItems = 'center';

                const h5 = document.createElement('h5');
                h5.textContent = title;
                h5.style.fontSize = '0.9rem';
                h5.style.color = '#555';
                h5.style.marginBottom = '10px';

                const canvasBox = document.createElement('div');
                canvasBox.style.height = '200px';
                canvasBox.style.width = '200px'; // Force square for consistent circle size
                canvasBox.style.position = 'relative';
                canvasBox.style.marginBottom = '10px';

                const canvas = document.createElement('canvas');

                canvasBox.appendChild(canvas);
                wrapper.appendChild(h5);
                wrapper.appendChild(canvasBox);

                // Prepare data
                const labels = Object.keys(breakdownData);
                const values = Object.values(breakdownData);

                // Filtre les valeurs 0 pour √©viter le clutter
                const filteredIndices = values.map((v, i) => v > 0 ? i : -1).filter(i => i !== -1);
                const finalLabels = filteredIndices.map(i => labels[i]);
                const finalValues = filteredIndices.map(i => values[i]);


                // Map colors to labels
                const usedColors = finalLabels.map(label => getFixedColor(label));

                container.appendChild(wrapper);

                new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: finalLabels,
                        datasets: [{
                            data: finalValues,
                            backgroundColor: usedColors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // Disable built-in legend
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.chart._metasets[context.datasetIndex].total;
                                        const percentage = Math.round((value / total) * 100) + '%';
                                        return `${label}: ${value.toLocaleString('fr-FR')} kgCO‚ÇÇe (${percentage})`;
                                    }
                                }
                            }
                        },
                        layout: {
                            padding: 0
                        }
                    }
                });
            };

            // Loop through years to create a row per year
            years.forEach((year) => {
                // Create Year Row
                const yearRow = document.createElement('div');
                yearRow.className = 'year-detail-row';
                yearRow.style.width = '100%';
                yearRow.style.border = '1px solid #dfe6e9';
                yearRow.style.borderRadius = '8px';
                yearRow.style.padding = '15px';
                yearRow.style.marginBottom = '30px';
                yearRow.style.backgroundColor = '#fafafa';

                const yearTitle = document.createElement('h3');
                yearTitle.textContent = `D√©tails Ann√©e ${year}`;
                yearTitle.style.borderBottom = '1px solid #ccc';
                yearTitle.style.paddingBottom = '10px';
                yearTitle.style.marginBottom = '20px';
                yearTitle.style.color = '#2d3436';
                yearRow.appendChild(yearTitle);

                // Flex Container for Charts
                const chartsFlex = document.createElement('div');
                chartsFlex.style.display = 'flex';
                chartsFlex.style.flexWrap = 'wrap';
                chartsFlex.style.gap = '15px';
                chartsFlex.style.justifyContent = 'space-around';

                const d = detailsData[year];

                // Create charts if data exists
                if (d.buildings) createDetailedDoughnut(chartsFlex, "B√¢timents (√ânergies)", d.buildings);
                if (d.vehicles) createDetailedDoughnut(chartsFlex, "V√©hicules (Carburants)", d.vehicles);
                if (d.food) createDetailedDoughnut(chartsFlex, "Alimentation (Repas)", d.food);
                if (d.purchases) createDetailedDoughnut(chartsFlex, "Achats (Cat√©gories)", d.purchases);
                if (d.numerique) createDetailedDoughnut(chartsFlex, "Num√©rique (Mat√©riel)", d.numerique);

                yearRow.appendChild(chartsFlex);
                sectorContainer.appendChild(yearRow);
            });

        } catch (e) {
            console.error("Erreur chargement graphiques:", e);
            const container = document.querySelector('.container');
            if (container) {
                const errorDiv = document.createElement('div');
                errorDiv.style.color = 'red';
                errorDiv.style.padding = '20px';
                errorDiv.innerHTML = `<strong>Erreur lors du chargement des statistiques:</strong><br>${e.message}`;
                container.prepend(errorDiv);
            }
        }
    });
</script>
{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .page-title {
        color: var(--primary, #2d6a4f);
        margin: 0;
    }

    .chart-section {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
    }

    .section-title {
        color: #495057;
        font-size: 1.25rem;
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .chart-container-large {
        position: relative;
        height: 400px;
        width: 100%;
    }

    .btn--secondary {
        background-color: #6c757d;
        color: white;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .btn--secondary:hover {
        background-color: #5a6268;
    }
</style>
{% endblock %}