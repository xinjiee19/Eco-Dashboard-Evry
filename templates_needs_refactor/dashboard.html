{% extends 'base.html' %}
{% load static %}

{% block title %}Tableau de bord - Bilan Carbone {% now "Y" %} {% endblock %}

{% block content %}
<div class="container">
    <div class="dashboard-welcome">
        <div class="welcome-header">
            <div>
                <h2 class="dashboard-title">Bonjour {{ user.get_full_name|default:user.username }} üëã</h2>
                <p class="dashboard-subtitle">Bienvenue sur l'application de bilan carbone municipal</p>
            </div>
            {% if user.is_staff %}
            <div class="admin-actions">
                <a href="{% url 'send_reminder' %}" class="btn btn-primary" title="Envoyer un rappel aux agents">
                    üìß Envoyer rappel
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Section Graphique Vue d'Ensemble -->
    <div class="emissions-overview">
        <h2 class="section-title">üìä Vue d'Ensemble des √âmissions {% now "Y" %} (Global)</h2>
        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="emissionsChart"></canvas>
                <div id="chartLoading" class="chart-loading">
                    <span>Chargement des donn√©es...</span>
                </div>
                <div id="chartError" class="chart-error" style="display: none;">
                    <p>‚ùå Erreur lors du chargement des donn√©es</p>
                </div>
            </div>
            <div class="chart-stats">
                <div class="chart-stat-card">
                    <h3>Total des √âmissions</h3>
                    <p id="totalEmissions" class="chart-stat-value">-- kg CO‚ÇÇe</p>
                </div>
                <div class="chart-legend" id="chartLegend">
                    <!-- Legend will be populated by JavaScript -->
                </div>

                <div style="margin-top: 1rem; text-align: center;">
                    <a href="{% url 'statistics' %}" class="btn-stats-link">
                        üìä Voir statistiques d√©taill√©es & comparatifs
                    </a>
                </div>
            </div>
        </div>
    </div>

    
    <div class="info-section">
        <h3>üìö Informations utiles</h3>
        <ul>
            <li><strong>Facteurs ADEME</strong> : Les calculs utilisent les facteurs officiels de la Base Carbone¬Æ
                ADEME
                (v√©rifi√©s janvier 2026)</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .dashboard-welcome {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid #e9ecef;
    }

    .welcome-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
    }

    .admin-actions {
        display: flex;
        gap: 0.5rem;
    }

    .dashboard-title {
        font-size: 1.75rem;
        color: var(--primary, #2d6a4f);
        margin-bottom: 0.5rem;
    }

    .dashboard-subtitle {
        color: var(--text-light, #6c757d);
        font-size: 1rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 1rem;
    }

    .stat-card__icon {
        font-size: 2.5rem;
    }

    .stat-card__title {
        font-size: 0.875rem;
        color: var(--text-light, #6c757d);
        margin-bottom: 0.5rem;
    }

    .stat-card__value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary, #2d6a4f);
        margin-bottom: 0.25rem;
    }

    .stat-card__label {
        font-size: 0.75rem;
        color: var(--text-light, #6c757d);
    }

    .modules-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .module-card {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        transition: all 0.2s;
    }

    .module-card:not(.module-card--disabled):hover {
        border-color: var(--primary, #2d6a4f);
        box-shadow: 0 4px 8px rgba(45, 106, 79, 0.1);
    }

    .module-card--disabled {
        opacity: 0.6;
    }

    .module-card__header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .module-card__icon {
        font-size: 1.75rem;
    }

    .module-card__title {
        font-size: 1.125rem;
        color: var(--primary, #2d6a4f);
        margin: 0;
    }

    .module-card__description {
        color: var(--text-light, #6c757d);
        font-size: 0.875rem;
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .module-card__stats {
        margin-bottom: 1rem;
    }

    .module-card__badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .module-card__badge--info {
        background-color: #cfe2ff;
        color: #084298;
    }

    .module-card__badge--disabled {
        background-color: #e9ecef;
        color: #6c757d;
    }

    .module-card__actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .module-card__actions .btn {
        flex: 1;
        text-align: center;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
    }

    .info-section {
        background: #f8f9fa;
        border-left: 4px solid var(--primary, #2d6a4f);
        padding: 1.5rem;
        border-radius: 4px;
    }

    .info-section h3 {
        margin-bottom: 1rem;
        color: var(--primary, #2d6a4f);
    }

    .info-section ul {
        list-style: none;
        padding: 0;
    }

    .info-section li {
        margin-bottom: 0.75rem;
        color: var(--text-dark, #212529);
        line-height: 1.6;
    }

    .info-section a {
        color: var(--primary, #2d6a4f);
        text-decoration: none;
    }

    .info-section a:hover {
        text-decoration: underline;
    }

    /* === Emissions Overview Chart === */
    .emissions-overview {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .section-title {
        font-size: 1.5rem;
        color: var(--primary, #2d6a4f);
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .chart-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        align-items: center;
    }

    .chart-wrapper {
        position: relative;
        height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chart-loading,
    .chart-error {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--text-light, #6c757d);
        font-size: 0.875rem;
    }

    .chart-error p {
        color: #dc3545;
        font-weight: 500;
    }

    .chart-stats {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .chart-stat-card {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
    }

    .chart-stat-card h3 {
        font-size: 0.875rem;
        color: var(--text-light, #6c757d);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .chart-stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary, #2d6a4f);
        margin: 0;
    }

    .chart-legend {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem;
        border-radius: 6px;
        transition: background 0.2s;
    }

    .legend-item:hover {
        background: #f8f9fa;
    }

    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        flex-shrink: 0;
    }

    .legend-label {
        flex: 1;
        font-size: 0.875rem;
        color: var(--text-dark, #212529);
        font-weight: 500;
    }

    .legend-value {
        font-size: 0.875rem;
        color: var(--text-light, #6c757d);
    }

    .legend-percentage {
        font-size: 0.75rem;
        color: var(--text-light, #6c757d);
        margin-left: 0.25rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .chart-container {
            grid-template-columns: 1fr;
        }

        .chart-wrapper {
            height: 250px;
        }
    }

    .btn-stats-link {
        display: inline-block;
        color: var(--primary, #2d6a4f);
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
        border: 1px solid var(--primary, #2d6a4f);
        border-radius: 4px;
        transition: all 0.2s;
        width: 100%;
        text-align: center;
    }

    .btn-stats-link:hover {
        background-color: var(--primary, #2d6a4f);
        color: white;
    }

    /* Sensibilisation Styles 
    .sensi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .sensi-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border: 1px solid #eee;
        padding: 1.5rem;
        height: 100%;
    }

    .sens-card--message {
        border-left: 5px solid #4A90E2;
        background: #f8fbff;
    }

    .sensi-card--conseils {
        border-left: 5px solid #2d6a4f;
    }

    .sensi-card--equivalences {
        border-left: 5px solid #F39C12;
    }

    .sensi-card__header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .sensi-icon {
        font-size: 1.5rem;
    }

    .sensi-card__header h3 {
        margin: 0;
        color: #333;
        font-size: 1.1rem;
    }

    .conseil-item {
        background: #fff;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 10px;
        border: 1px solid #eee;
    }

    .conseil-item strong {
        color: #2d6a4f;
        display: block;
        margin-bottom: 4px;
    }

    .conseil-item p {
        margin: 0;
        font-size: 0.9rem;
        color: #666;
    }

    .equivalences-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .eq-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 0.5rem;
    }

    .eq-icon {
        font-size: 1.5rem;
        margin-bottom: 0.2rem;
    }

    .eq-val {
        font-weight: 800;
        font-size: 1.2rem;
        color: #333;
    }

    .eq-label {
        font-size: 0.8rem;
        color: #777;
    }*/
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    // Function to load and display emissions chart
    async function loadEmissionsChart() {
        const chartCanvas = document.getElementById('emissionsChart');
        const chartLoading = document.getElementById('chartLoading');
        const chartError = document.getElementById('chartError');
        const totalEmissionsEl = document.getElementById('totalEmissions');
        const legendEl = document.getElementById('chartLegend');

        try {
            // Fetch data from API
            const response = await fetch('{% url "dashboard_emissions_api" %}');
            if (!response.ok) {
                throw new Error('Failed to fetch data');
            }

            const data = await response.json();

            // Hide loading indicator
            chartLoading.style.display = 'none';

            // Check if we have any data
            const hasData = data.data.some(value => parseFloat(value) > 0);

            if (!hasData) {
                chartError.innerHTML = '<p>üìä Aucune donn√©e d\'√©mission disponible.<br>Commencez par saisir des donn√©es dans les modules.</p>';
                chartError.style.display = 'block';
                totalEmissionsEl.textContent = '0 kg CO‚ÇÇe';
                return;
            }

            // Update total emissions
            totalEmissionsEl.textContent = `${parseFloat(data.total).toLocaleString('fr-FR')} kg CO‚ÇÇe`;

            // Create custom legend
            legendEl.innerHTML = data.labels.map((label, index) => {
                const value = parseFloat(data.data[index]);
                const percentage = ((value / parseFloat(data.total)) * 100).toFixed(1);
                return `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${data.colors[index]}"></div>
                        <span class="legend-label">${label}</span>
                        <span class="legend-value">
                            ${value.toLocaleString('fr-FR')} kg
                            <span class="legend-percentage">(${percentage}%)</span>
                        </span>
                    </div>
                `;
            }).join('');

            // Initialize Chart.js donut chart
            new Chart(chartCanvas, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data.map(v => parseFloat(v)),
                        backgroundColor: data.colors,
                        borderWidth: 0,
                        hoverOffset: 10,
                        hoverBorderWidth: 2,
                        hoverBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false  // Use custom legend instead
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 6,
                            titleFont: { size: 14, weight: '600' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: (context) => {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${value.toLocaleString('fr-FR')} kg CO‚ÇÇe (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: false,
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    cutout: '65%'  // Makes it a donut instead of pie
                }
            });

        } catch (error) {
            console.error('Error loading emissions chart:', error);
            chartLoading.style.display = 'none';
            chartError.style.display = 'block';
        }
    }

    // Load chart when page is ready
    document.addEventListener('DOMContentLoaded', loadEmissionsChart);

</script>
{% endblock %}